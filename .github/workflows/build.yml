# SHOULD DO: dedupe these and clean them up
on:
  push:
    branches: [ master ]
  pull_request:

name: Build Verification

jobs:
  setup_environment:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Rust Environment
        uses: ./.github/actions/setup-rust-environment/

  formatting:
    name: Check for Formatting Issues
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Rust Environment (Cached)
        uses: ./.github/actions/setup-rust-environment/

      - name: Check Formatting
        run: cargo fmt -- --check

  build_pressure:
    name: Build with Pressure Feature
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Rust Environment (Cached)
        uses: ./.github/actions/setup-rust-environment/

      - name: "Build with Pressure Feature"
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --features pressure

  build_temperature:
    name: Build with Temperature Feature
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Rust Environment (Cached)
        uses: ./.github/actions/setup-rust-environment/

      - name: "Build with Temperature Feature"
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --features temperature

  build_strain:
    name: Build with Strain Feature
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Rust Environment (Cached)
        uses: ./.github/actions/setup-rust-environment/

      - name: "Build with Strain Feature"
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --features strain

  test:
    name: Run Host Tests
    needs: setup_environment
    runs-on: ubuntu-latest
    env:
      RUST_MIN_STACK: 8388608
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup Rust Environment (Cached)
        uses: ./.github/actions/setup-rust-environment/

      - uses: actions-rs/cargo@v1
        name: "Run Host Tests"
        with:
          command: make
          args: test-host